<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Frameset//EN" "http://www.w3.org/TR/html4/frameset.dtd">
<html style="height: 100%;">
<head>
	<title>_TITLE_ - _COMPOSER_ - Online Partitur Player</title>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/themes/smoothness/jquery-ui.css" rel="stylesheet" type="text/css"/>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js"></script>
    <script type="text/javascript" src="js/css-pop.js"></script>
    <link rel="stylesheet" href="template.css">  
	<link rel='shortcut icon' type='image/x-icon' href='favicon.ico' />

<!-- Lets load up prefixfree to handle CSS3 vendor prefixes -->
<script src="prefixfree.js" type="text/javascript"></script>
<!-- You can download it from http://leaverou.github.com/prefixfree/ -->
<script>
var lensactive = false;
$(document).ready(function(){

	var native_width = 0;
	var native_height = 0;
	var mousex = 0;
	var mousey = 0;

	$(".magnify").mousemove(function(e){
		if (lensactive == true) {
		if(!native_width && !native_height)
		{

			var image_object = new Image();
			image_object.src = $(".small").attr("src");
			

			native_width = image_object.width;
			native_height = image_object.height;
		}
		else
		{

			var magnify_offset = $(this).offset();

			if (e.pageX > 0){
				mousex = e.pageX;
				mousey = e.pageY;
				var mx = e.pageX - magnify_offset.left;
				var my = e.pageY - magnify_offset.top;
			}
			else {
				var mx = mousex - magnify_offset.left;
				var my = mousey - magnify_offset.top;				
			}
			console.log(mx + " ---- " + my + "- " + e.pageX + " ---- " + e.pageY);


			if(mx < $(this).width() && my < $(this).height() && mx > 0 && my > 0)
			{
				$(".large").fadeIn(100);
			}
			else
			{
				$(".large").fadeOut(100);
			}
			if($(".large").is(":visible"))
			{

				var rx = Math.round(mx/$(".small").width()*native_width - $(".large").width()/2)*-1;
				var ry = Math.round(my/$(".small").height()*native_height - $(".large").height()/2)*-1;
				var bgp = rx + "px " + ry + "px";
				

				var px = mx - $(".large").width()/2;
				var py = my - $(".large").height()/2;

				$(".large").css({left: px, top: py, backgroundPosition: bgp});
			}
		}
	}})
})
</script>
    <style>
/*Some CSS*/
.magnify {width: 100%; height:100%;margin: 0 auto; position: relative;}

/*Lets create the magnifying glass*/
.large {
	width: 300px; height: 300px;
	position: absolute;
	border-radius: 100%;
	
	/*Multiple box shadows to achieve the glass effect*/
	box-shadow: 0 0 0 7px rgba(255, 255, 255, 0.85), 
	0 0 7px 7px rgba(0, 0, 0, 0.25), 
	inset 0 0 40px 2px rgba(0, 0, 0, 0.25);
	
	/*Lets load up the large image first*/
	background: url('rep/_OPUS_/media/_OPUS_-0.png') no-repeat;
	
	/*hide the glass by default*/
	display: none;
}

/*To solve overlap bug at the edges during magnification*/
.small { display: block; }

        #divContainer, #divResize{ 
            border:dashed 3px #CCC; 
            border-color: #222222:
            opacity: 1;
            width:46%; 
            height:120px; 
            padding:5px; 
            margin:5px; 
            position: fixed;
            top: 50%;
            left: 50%;
            font:13px Arial; 
            cursor:move; 
            float:left 
            z-index: 1000;
            display: block;
        } 		
		table {
			border:0px solid #CCC;
			border-collapse:collapse;
		}
		td 		{
			border:none;
		}
textarea {
    overflow-y: scroll;
    height: 400px;
    resize: none; /* Remove this if you want the user to resize the textarea */
}
a.button {
  border-style: solid;
  border-width : 1px 1px 1px 1px;
  text-decoration : none;
  padding : 4px;
  border-color : #000000;

}
body {
  font-family: Arial;
  position: relative;
}
html, body
{
  height: 100%;
}
img {

}

@keyframes blink {
  50% {
    opacity: 0.0;
    color: #ddddff;
  }
}
@-webkit-keyframes blink {
  50% {
    opacity: 0.0;
    color: #ffffff;
  }
}
.skip {
  animation: blink 1s step-start 0s infinite;
  -webkit-animation: blink 1s step-start 0s infinite;
}
    </style>
	<script type="text/javascript">

function getRandomArbitrary(min, max) {
    return Math.random() * (max - min) + min;
}
function logmsg(msg) {
	var currentdate = new Date(); 
	var utc = new Date().toJSON().slice(0,10);
	var datetime = utc + " @ "  + currentdate.getHours() + ":"  + currentdate.getMinutes() + ":" + currentdate.getSeconds();
	t = "?"
	try {
		t = player.getCurrentTime();
	}
	catch(err) {
		dummy = 0;
	}
    var i = new Image();
    i.src = 'log.php?msg=' + datetime + "- " + id + " - " + msg + " - " + t.toString();
	
}	
	

var id = getRandomArbitrary(1,1000000000);
logmsg("LOADED");

window.onbeforeunload = function (e) {
  logmsg("EXIT");
};	

var playeractive = true;
<!--
function toggle_visibility(id) {
	var e = document.getElementById(id);
	if(e.style.display == 'block') {
		e.style.display = 'none';
		playeractive = false;
	}
	else {
		e.style.display = 'block';
		playeractive = true;
	}
}
//-->
</script>
<script>
function fmtMSS(s){return(s-(s%=60))/60+(9<s?':':':0')+s}

var recordcursor = 0;
//Load files

opus = "_OPUS_";

var xhr = new XMLHttpRequest();
xhr.open('GET', 'rep/_OPUS_/score', false);
xhr.send(null);
var trackscore = xhr.responseText.split('\n');

var xhr = new XMLHttpRequest();
xhr.open('GET', 'rep/_OPUS_/markers', false);
xhr.send(null);
var markers = xhr.responseText.split('\n');

$(document).ready(function() {		
	$("#textarea").html(xhr.responseText);
});	
</script>	

<script src="https://www.youtube.com/iframe_api"></script>
	
<meta http-equiv="content-type" content="text/html; charset=utf-8">
</head>

<body style="height: 100%;">
<ul>
<li><a class="active" href="rep.html"><b>Repertoire</b></a></li>
<li><a class="sharelink" href="#" id="share" onclick="document.getElementById('shareframe').src = 'share.php?opus=_OPUS_&t=' + Math.round(t).toString(); popup('popUpDiv');"><img style="width:12px; height:12px; position: relative;" src="link.png">   Share</a></li>
<li><a href="#" id="playertoggle" onclick="toggle_visibility('divResize');"><img style="width:12px; height:12px; position: relative;" src="player.png">   Player</a></li>
<li><a href="#" id="magnifytoggle" onclick="lensactive = !lensactive;"> <img style="width:12px; height:12px; position: relative;" src="magnify.png">   Magnifier</a></li>
<li><a href="#" id="pagetoggle" onclick="transissionactive = !transissionactive;"><img style="width:12px; height:12px; position: relative;" src="page.png">   Page turn</a></li>

  _MENU_
</ul>
	
	<div id="divResize" style="width:47%; height:45%;z-index: 1000;"><br><div id="player"><br></div></div>
	
	<!--_BEGINEDITOR_-->
	<div id="settings" style="position:absolute;z-index:300; top:0px; left:50%;"><br>
	<table bgcolor="#00FF00"><tr>
	<td><input type="button" id="markbtn" value="Mark"></td>
	<td><div id="indicator">0</div>Cursor</td>
	<td><div id="indicator2">0</div>Page</td>
	</tr></table>
	<textarea id="textarea" style="width:300; height:400;" rows="20"></textarea>
	<script>
	var recordcursor = 0;
		
	$(document).ready(function() {
		$("#markbtn").click( function() {
			t = player.getCurrentTime();
			var lines = $('#textarea').val().split(/\n/);
			lines[recordcursor] = t.toString();
			$("#textarea").val(lines.join("\n"));
			trackscore = $('#textarea').val().split(/\n/);
			
			recordcursor += 1;
			$("#indicator").html(recordcursor);
		});
	});	
	$(document).ready(function() {		
		$("#textarea").click( function() {
			trackscore = $('#textarea').val().split(/\n/);
			recordcursor = textarea.value.substr(0, textarea.selectionStart).split("\n").length - 1;
			$("#indicator").html(recordcursor);
			player.seekTo($('#textarea').val().split(/\n/)[recordcursor - 1]);
		});
	});	
	</script>
	</div>
	
	<!--_ENDEDITOR_-->
	
   <!-- 1. The <iframe> (and video player) will replace this <div> tag. -->
    <script>
      // 2. This code loads the IFrame Player API code asynchronously.
      var tag = document.createElement('script');

      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

      // 3. This function creates an <iframe> (and YouTube player)
      //    after the API code downloads.
      var player;
      function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
          height: '93%',
          width: '93%',
          videoId: '_CODE_',
          
		  events: {
            'onReady': onPlayerReady,
            'onStateChange': onPlayerStateChange
          },
		  playerVars: {
          start: _BEGINPLAY_,
          end: _END_
	      }
        });
        
      }

      // 4. The API will call this function when the video player is ready.
      function onPlayerReady(event) {
        event.target.playVideo();
      }

      // 5. The API calls this function when the player's state changes.
      //    The function indicates that when playing a video (state=1),
      //    the player should play for six seconds and then stop.
      var done = false;
      function onPlayerStateChange(event) {
		logmsg("YT player"  + player.getPlayerState().toString());
        if (event.data == YT.PlayerState.PLAYING && !done) {
          //setTimeout(stopVideo, 6000);
          done = true;
        }
      }
      function stopVideo() {
        player.stopVideo();
      }
      

    </script>

<script>
var skiptime = 0;
 $( document ).ready(function() { 
      $("#skip").click(function(event) { 
        player.seekTo(skiptime);
        event.preventDefault(); 
      }); 
 });
</script>
	
	
<table id="container" style="vertical-align: top;padding:0px; width: 100%; height:90%; top:30px; left:0px; position:absolute; z-index: 100;" border="0">
<tr>
<td width="50%" style="padding:3px">
<i>_COMPOSER_</i><br>
<h3 style="display:inline;">_TITLE_ </h2>  
<div id="bar" style="color:#ffffff; background-color:#000000; padding:5px;">
<a href="#" onclick="player.playVideo();"><img style="width:16px; height:16px; position: relative;" src="play.png"></a>
<a href="#" onclick="player.pauseVideo();"><img style="width:16px; height:16px; position: relative;" src="pause.png"></a>	
<a href="#" onclick="player.stopVideo();"><img style="width:16px; height:16px; position: relative;" src="stop.png"></a>
<a href="#" onclick="player.seekTo(_BEGIN_);"><img style="width:16px; height:16px; position: relative;" src="reset.png"></a>&nbsp;
<div id="baro" style="display: inline;">
Page 1 - 0:00</div>
<div id="skip" class="skip" style="display: inline; visibility: hidden; color: #ddddff; float: right; cursor: pointer;">
<b>Skip repetition</b></div>
</div>
<div id="barcontainer" style="width:100%; height:2px;pading:3px">
  <div id="progress-bar" style="background-color:#ff0000;height:3px;transition:300ms linear;">
  </div>
</div>
<div id="barcontainer2" class="tooltips" style="background-color:#ccccff;width:100%; height:6px;pading:3px;cursor: hand;">
  <div id="progress-bar2" style="background-color:#0000ff;height:6px;transition:300ms linear;">
  </div>
</div>

</td>
<td style="padding:10px" width="50%">
<div style="color:#999999;">
<b>Score </b>_SCORE_
<b>Music </b>_MUSIC_
</div>
</td>
</tr>
<tr id="left" height="auto">
<td width="50%" align="right">
<!-- Lets make a simple image magnifier -->
<div class="magnify" id="magnify">
	<div id="large" class="large"></div>
	<!-- This is the magnifying glass which will contain the original/large version -->
<img id="score" style="max-width:100%;max-height:100%;width: auto;height: auto;" class="small" src="rep/_OPUS_/media/_OPUS_-0.png" name="edit-save" />
  </div>

</td>

<td id="right" width="50%" align="left">

<img id="score2" style="max-width:100%;max-height:100%;width: auto;height: auto;" src="rep/_OPUS_/media/_OPUS_-1.png" name="edit-save"/>

</td>
</tr>
</table>

<script>
$(document).click(function(event) {
	logmsg(event.target);
});

lastcursor = 0;

setInterval(function update() {
	t = player.getCurrentTime();
	//console.log(t);
	$("#indicator").html(recordcursor);
	
	//UPDATE SCORE
	cursor = 1;
	while (parseInt(trackscore[cursor]) < t) {
		cursor = cursor + 1;
	}
	if (cursor == lastcursor + 1) {
		lastcursor = cursor;
		if (cursor > 1) {
			transission();
		}
	}
	else {
		lastcursor = cursor;
	}
	cursor = cursor - 1;
	if (($("cursorscore").src != "rep/_OPUS_/media/_OPUS_-" + cursor.toString() + ".png") && (cursor >= 0))  {
		document.getElementById("score").src="rep/_OPUS_/media/_OPUS_-" + cursor.toString() + ".png";
		document.getElementById("large").style.background = "url('" + "rep/_OPUS_/media/_OPUS_-" + cursor.toString() + ".png" + "') no-repeat";
	}
	if (cursor + 1 <= trackscore.length - 1) {
		var duration = trackscore[cursor + 1] - trackscore[cursor];
		var remaining = trackscore[cursor + 1] - t;
		if (trackscore[cursor] == 0){
			var duration = trackscore[cursor + 1] - _BEGIN_ - trackscore[cursor];
			var remaining = trackscore[cursor + 1] - t;			
		}
		var percent = (1 - remaining / parseFloat(duration))*100;
	}
	else {
		percent = 100;
	}
	var elem = document.getElementById('progress-bar');
	var elem2 = document.getElementById('barcontainer');
	elem.style.width = percent.toString() + "%";
	if ( (cursor & 1) == 0 )
	{ 
		elem.style.backgroundColor = "#ff0000";
		elem2.style.backgroundColor = "#000000";
		}
	else
	{ 
		elem.style.backgroundColor = "#000000";
		elem2.style.backgroundColor = "#ff0000";
		} 
	
	cursor = cursor + 1;
	if((document.getElementById("score2").src != "rep/_OPUS_/media/_OPUS_-" + cursor.toString() + ".png") && (cursor >= 0)) {
		document.getElementById("score2").src="rep/_OPUS_/media/_OPUS_-" + cursor.toString() + ".png";
		$('#magnify').trigger('mousemove');
	}

	recordcursor = cursor;
	$("#indicator2").html(cursor - 1);
	$("#indicator").html(recordcursor);
	$("#baro").html("Page " + recordcursor.toString() + " - " + fmtMSS(Math.floor(t - _BEGIN_)) + " / " + fmtMSS(_END_ - _BEGIN_));
	$("#textarea").scrollTop = cursor;
	
	var elem3 = document.getElementById('progress-bar2');
	var percent2 = ((t - _BEGIN_) / parseFloat(_END_ - _BEGIN_))*100;
	elem3.style.width = percent2.toString() + "%";
	
	
	//update toggle indicators
	console.log(lensactive);
	if (lensactive == true) {
		document.getElementById('magnifytoggle').style.color = 'lightgreen'; 
	}
	else { 
		document.getElementById('magnifytoggle').style.color = 'white'; 
	}
	if (transissionactive == true) {
		document.getElementById('pagetoggle').style.color = 'lightgreen'; 
	}
	else { 
		document.getElementById('pagetoggle').style.color = 'white'; 
	}
	if (playeractive == true) {
		document.getElementById('playertoggle').style.color = 'lightgreen'; 
	}
	else { 
		document.getElementById('playertoggle').style.color = 'white'; 
	}
	
	//Handle Skip Button
	document.getElementById('skip').style.visibility = 'hidden'; 
	var index;
	for (index = 0; index < markers.length; ++index) {
		skipstart = markers[index].split(",")[0];
		skipend = markers[index].split(",")[1];
		
		if ((t > skipstart) && (t < skipend)) {
			document.getElementById('skip').style.visibility = 'visible'; 
			skiptime = skipend;
			
		}
	}
	
}, 300);

</script>
<script>
    var element_pos = 0; 
    var iCnt = 0;
    $(document).ready(function() {

        $(function() {
			$('#divContainer').draggable(); 
			
			});
        $(function() {
			$("#divResize").draggable().resizable();
				containment: 'container'
			
			});
			

    });
</script>

<script>
transissionactive = true;

function transission(){
if (transissionactive == true) {
var oold = $('#score2');

var onew = $('#score');
var newOffset = onew.offset();
var height = onew.height();
var width = onew.width();
var oldOffset = oold.offset();
topcorr = 8;
leftcorr = 8;
var oImg=document.createElement("img");
oImg.setAttribute('src', "rep/_OPUS_/media/_OPUS_-" + (cursor-1).toString() + ".png");
oImg.setAttribute('alt', 'Loading...');
oImg.setAttribute('height', height + "px");
oImg.setAttribute('width', width+"px");
oImg.setAttribute('id', "copy");
oImg.setAttribute('class', "copy");
oImg.setAttribute('style', "position: absolute;z-index:300;top:" + (oldOffset.top - topcorr) + "px;left:" + (oldOffset.left - leftcorr)+ "px;");
document.body.appendChild(oImg);

var oImg2=document.createElement("img");
oImg2.setAttribute('src', "rep/_OPUS_/media/_OPUS_-" + (cursor-2).toString() + ".png");
oImg2.setAttribute('alt', 'Loading...');
oImg2.setAttribute('height', height + "px");
oImg2.setAttribute('width', width+"px");
oImg2.setAttribute('id', "copy2");
oImg2.setAttribute('class', "copy2");
oImg2.setAttribute('style', "position: absolute;z-index:300;top:" + (newOffset.top - topcorr) + "px;left:" + (newOffset.left  - leftcorr)+ "px;");
document.body.appendChild(oImg2);

/*
var oImg3=document.createElement("img");
oImg3.setAttribute('src', "rep/_OPUS_/media/_OPUS_-" + (cursor).toString() + ".png");
oImg3.setAttribute('alt', 'Loading...');
oImg3.setAttribute('height', height + "px");
oImg3.setAttribute('width', width+"px");
oImg3.setAttribute('id', "copy3");
oImg3.setAttribute('class', "copy3");
oImg3.setAttribute('style', "position: absolute;z-index:300;overflow: hidden;top:" + (oldOffset.top - topcorr) + "px;left:" + (oldOffset.left - leftcorr + width)+ "px;");
document.body.appendChild(oImg3);
*/
$("#copy").animate({'left':(newOffset.left - leftcorr)}, 2500, function () { $("#copy").remove(); });
$("#copy2").animate({'left': -width}, 2500, function () { $("#copy2").remove();});
//$("#copy3").animate({'left':(oldOffset.left - leftcorr)}, 2350, function () { $("#copy3").remove(); });
}}
</script>

<div id="blanket" style="display:none;"></div>
<div id="popUpDiv" style="display:none;">
<iframe scroling="no" id="shareframe" style="width:100%; height:80%; word-wrap: break-word;overflow:hidden;" frameborder="0" src="http://www.google.com">iframe not supported!</iframe> 
<a href="#" onclick="popup('popUpDiv')" >Close</a>
</div>	

_TRACKING_

<script>
var mpageX;
//Clickable ProgressBar 2 (blue)
$('#barcontainer2').click(function (e){
    var elm = $(this);
    var mxPos = e.pageX - elm.offset().left;
	var width = $("#barcontainer2").width();
    var per = mxPos/parseFloat(width);
    player.seekTo(per*(_END_ - _BEGIN_) + _BEGIN_);
});

function n(n){
    return n > 9 ? "" + n: "0" + n;
}
//Tooltip
$('#barcontainer2').mousemove(function (e){
	  mpageX = e.pageX;
	  $( "#barcontainer2" ).tooltip({
		items: '#barcontainer2',
		content: function(e) {
			var elm = $("#barcontainer2");
			var mxPos = mpageX - elm.offset().left;
			var width = $("#barcontainer2").width();
			var per = mxPos/parseFloat(width);
			var tim = (per*(_END_ - _BEGIN_)); //Without _BEGIN_
			return Math.floor(tim/parseFloat(60)) + ":" + n(Math.floor(tim%60)); },
			
	  });
});




</script>

</body>
</html>
